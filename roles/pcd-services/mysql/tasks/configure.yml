---
##
# pcd-services/mysql configure
#

- name: fetch mysqltuner.pl script
  get_url:
    dest=/usr/local/bin/mysqltuner.pl
    force=yes
    url=https://raw.githubusercontent.com/major/MySQLTuner-perl/master/mysqltuner.pl
    mode=0755
    
- name: copy over defragmentation script
  copy:
    src="defrag_mysql.sh"
    dest={{ mysql_defrag_script }}
    mode=0755
    
- name: schedule defragmentation of databases
  cron: 
    name="defragment mysql databases"
    job="{{ PCD_CRON_PREFIX }}{{ mysql_defrag_script }}"
    minute={{ mysql_defrag_minute }}
    hour={{ mysql_defrag_hour }}
    state=present
    user=root

- name: update my.cnf
  template: 
    src={{ mysql_config_template }}
    dest={{ os_mysql_conf_file }}
  notify: mysql restart
  
#@ todo - build a few configuration files based on max ram, detect and use appropriate
      
# Auto-Restart MySQL   
- { include: "{{ pcd_task_autorestart_service }}", task: {
      service: "{{ os_mysql_service }}",
      enabled: "{{ MYSQL_AUTORESTART }}"
    }
  }
      